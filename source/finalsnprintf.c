#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

typedef int (*orig_snprintf_type)(char *str,size_t size, const char *format, ...);

int snprintf(char *str,size_t size,const char *format, ...){
// const char validchars[] = {'-', '+', '0', ' ', '#','0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '*','h', 'l', 'L', 'z', 'j', 't' };
const char validS[] = {'-', '+', '0', ' ', '#','0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '*','h', 'l', 'L', 'z', 'j', 't', '\0' };
va_list args;        
va_start(args, format);
orig_snprintf_type orig_snprintf;
orig_snprintf = (orig_snprintf_type)dlsym(RTLD_NEXT,"snprintf");

if(!format){
	format ="%s";
}
 // int result =orig_snprintf(buffer,args);  
// const char *format="%.3f\n%.3g\n%.3f\n%.3g\n%.+l6n%%n%d";
//const char *format="%.3f\n%.3g\n%.3f\n%.3g\n%n%%n";
const char *traverse;
// char buffer[strlen(format)];	
// int n_args = 0;
bool nFlag = false;
bool longFlag = false;
int k=0;
char tempBuff[strlen(format)];
for(traverse = format; *traverse != '\0'; traverse++) {
   if( *traverse == '%' ){
      nFlag=false;
      longFlag = false;
      // printf("A\n");
      if(k!=0){
      	tempBuff[k++]='\0';
	orig_snprintf(str,size,tempBuff);
	memset(tempBuff,0,strlen(format));
	k=0;	      
	}	
      if(strchr(validS,*(traverse+1))){
	tempBuff[k++]=*traverse;
	nFlag=true;
	continue;
      }
  	
      switch(*(traverse+1)){
	
    case 'n':
             	traverse++; 
             	va_arg(args, int *);
             	break;
	case '%':        		        	
	        	orig_snprintf(str,size,"%%");	        	
	        	traverse++;
	        	break; 
	case 'd':
	case 'i':
	case 'c':
				tempBuff[k++]=*traverse;
	        	tempBuff[k++]=*(traverse+1);
	        	tempBuff[k++]='\0';
	        	orig_snprintf(str,size,tempBuff,va_arg(args,int));
	        	memset(tempBuff,0,strlen(format));
		    	k=0;
	        	traverse++;
	        	break; 
	case 'u':
	case 'o':
	case 'x':
	case 'X':
				tempBuff[k++]=*traverse;
	        	tempBuff[k++]=*(traverse+1);
	        	tempBuff[k++]='\0';
	        	orig_snprintf(str,size,tempBuff,va_arg(args,unsigned long));
	        	memset(tempBuff,0,strlen(format));
		    	k=0;
	        	traverse++;
	        	break; 
	case 'F':
	case 'f':
	case 'e':
	case 'E':
	case 'g':
	case 'G':
				tempBuff[k++]=*traverse;
	        	tempBuff[k++]=*(traverse+1);
	        	tempBuff[k++]='\0';
	        	orig_snprintf(str,size,tempBuff,va_arg(args,double));
	        	memset(tempBuff,0,strlen(format));
		    	k=0;
	        	traverse++;
	        	break; 	
	case 'A':
	case 'a':	
				tempBuff[k++]=*traverse;
            	tempBuff[k++]=*(traverse+1);
            	tempBuff[k++]='\0';
            	orig_snprintf(str,size,tempBuff,va_arg(args,double));
            	memset(tempBuff,0,strlen(format));
	    		k=0;
            	traverse++;
            	break; 
	case 's':
				tempBuff[k++]=*traverse;
            	tempBuff[k++]=*(traverse+1);
            	tempBuff[k++]='\0';
            	orig_snprintf(str,size,tempBuff,va_arg(args,char *));
            	memset(tempBuff,0,strlen(format));
	    		k=0;
            	traverse++;
            	break; 
	case 'p':

            	tempBuff[k++]=*traverse;
            	tempBuff[k++]=*(traverse+1);
            	tempBuff[k++]='\0';
            	orig_snprintf(str,size,tempBuff,va_arg(args,void *));
            	memset(tempBuff,0,strlen(format));
	    		k=0;
            	traverse++;
            	break; 

        default:
            	tempBuff[k++]=*traverse;
            	//tempBuff[1]='\0';
            	//printf("%s",tempBuff);
	    	//memset(tempBuff,0,strlen(format));
	    	//k=0;
	    		break;		
            
      }
   }
else{
	if(nFlag){
		if(strchr(validS,*traverse)){
			tempBuff[k++]=*traverse;
			if(*traverse=='l'||*traverse=='L'){
				longFlag=true;
			}
			continue;	
		}
		else{
			switch(*traverse){

			case 'n':
						traverse++; 		           
						va_arg(args, int *);
						memset(tempBuff,0,strlen(format));
						k=0;
						nFlag=false;
						break;		    	
			case 'd':
			case 'i':
			case 'c':
					tempBuff[k++]=*traverse;
		        	tempBuff[k++]=*(traverse+1);
		        	tempBuff[k++]='\0';
		        	if(longFlag)
		        		orig_snprintf(str,size,tempBuff,va_arg(args,long));
		        	else
		        		orig_snprintf(str,size,tempBuff,va_arg(args,int));
		        	memset(tempBuff,0,strlen(format));
			    	k=0;
		        	traverse++;
		        	break; 
			case 'u':
			case 'o':
			case 'x':
			case 'X':
					tempBuff[k++]=*traverse;
		        	tempBuff[k++]=*(traverse+1);
		        	tempBuff[k++]='\0';
		        	if(longFlag)
		        		orig_snprintf(str,size,tempBuff,va_arg(args,unsigned long));
					else
						orig_snprintf(str,size,tempBuff,va_arg(args,unsigned));        
		        	memset(tempBuff,0,strlen(format));
			    	k=0;
		        	traverse++;
		        	break; 

			case 'F':
			case 'f':
			case 'e':
			case 'E':
			case 'g':
			case 'G':
					tempBuff[k++]=*traverse;
		        	tempBuff[k++]=*(traverse+1);
		        	tempBuff[k++]='\0';
		        	orig_snprintf(str,size,tempBuff,va_arg(args,double));
		        	memset(tempBuff,0,strlen(format));
			    	k=0;
		        	traverse++;
		        	break; 	

			case 'A':
			case 'a':
					tempBuff[k++]=*traverse;
	            	tempBuff[k++]=*(traverse+1);
	            	tempBuff[k++]='\0';
	            	orig_snprintf(str,size,tempBuff,va_arg(args,double));
	            	memset(tempBuff,0,strlen(format));
		    		k=0;
	            	traverse++;
	            	break; 
			case 's':
					tempBuff[k++]=*traverse;
	            	tempBuff[k++]=*(traverse+1);
	            	tempBuff[k++]='\0';
	            	orig_snprintf(str,size,tempBuff,va_arg(args,char *));
	            	memset(tempBuff,0,strlen(format));
		    		k=0;
	            	traverse++;
	            	break; 

			case 'p':
				  	tempBuff[k++]=*traverse;
	            	tempBuff[k++]=*(traverse+1);
	            	tempBuff[k++]='\0';
	            	orig_snprintf(str,size,tempBuff,va_arg(args,void *));
	            	memset(tempBuff,0,strlen(format));
		    		k=0;
	            	traverse++;
	            	break; 
				
			default:
					tempBuff[k++]=*traverse;
					nFlag=false;
					break;
									
			

		    }	
		}	
	}
	else{
		tempBuff[k++]=*traverse;
	}
}
}	
		if(k!=0){
        tempBuff[k++] ='\0';
    }
        orig_snprintf(str,size,tempBuff);
        va_end(args);
        // printf("%d\n",n_args);
        // printf("%d\n",(int)strlen(format));
        // printf("%s\n",tempBuff);
        return 0;   
}


